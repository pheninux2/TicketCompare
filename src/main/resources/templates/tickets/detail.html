<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Ticket ' + ${ticket.id}"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .category-input-container {
            position: relative;
        }

        .btn-add-category {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        .update-status {
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .update-status.success {
            color: #198754;
        }

        .update-status.error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">üìä TicketCompare</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/tickets">Tickets</a>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2 th:text="'Ticket #' + ${ticket.id}"></h2>
            </div>
            <div class="col-md-4 text-end">
                <a th:href="@{/tickets/{id}/edit(id=${ticket.id})}" class="btn btn-warning">√âditer</a>
                <a href="/tickets" class="btn btn-secondary">Retour</a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Informations du Ticket</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Date:</strong> <span th:text="${ticket.date}"></span></p>
                        <p><strong>Magasin:</strong> <span th:text="${ticket.store}"></span></p>
                        <p><strong>Montant Total:</strong> <span th:text="${'‚Ç¨' + ticket.totalAmount}" class="badge bg-success"></span></p>
                        <p th:if="${ticket.notes}"><strong>Notes:</strong> <span th:text="${ticket.notes}"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Produits du Ticket</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Cat√©gorie</th>
                                <th>Prix</th>
                                <th>Quantit√©</th>
                                <th>Unit√©</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="product : ${ticket.products}">
                                <td th:text="${product.name}"></td>
                                <td>
                                    <div class="category-input-container">
                                        <select class="form-control form-control-sm category-select"
                                                th:id="'category-' + ${product.id}"
                                                th:data-product-id="${product.id}"
                                                onchange="updateCategory(this)">
                                            <option value="">-- S√©lectionner une cat√©gorie --</option>
                                            <option th:each="cat : ${categories}"
                                                    th:value="${cat}"
                                                    th:text="${cat}"
                                                    th:selected="${product.category == cat}"></option>
                                        </select>
                                    </div>
                                    <div class="update-status" th:id="'status-' + ${product.id}"></div>
                                </td>
                                <td th:text="${'‚Ç¨' + product.price}"></td>
                                <td th:text="${product.quantity}"></td>
                                <td th:text="${product.unit ?: '-'}"></td>
                                <td th:text="${'‚Ç¨' + product.totalPrice}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        /**
         * Met √† jour la cat√©gorie d'un produit via une requ√™te AJAX
         */
        function updateCategory(selectElement) {
            const productId = selectElement.getAttribute('data-product-id');
            const category = selectElement.value;
            const statusElement = document.getElementById('status-' + productId);

            if (!category) {
                statusElement.textContent = '';
                return;
            }

            // Afficher un indicateur de chargement
            statusElement.textContent = 'Mise √† jour...';
            statusElement.className = 'text-muted d-block mt-1';

            // Envoyer la requ√™te AJAX
            fetch(`/tickets/api/product/${productId}/category?category=${encodeURIComponent(category)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusElement.textContent = '‚úì Mise √† jour r√©ussie';
                    statusElement.className = 'text-success d-block mt-1';

                    // R√©initialiser le message apr√®s 3 secondes
                    setTimeout(() => {
                        statusElement.textContent = '';
                    }, 3000);
                } else {
                    statusElement.textContent = 'Erreur: ' + data.message;
                    statusElement.className = 'text-danger d-block mt-1';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                statusElement.textContent = 'Erreur de connexion';
                statusElement.className = 'text-danger d-block mt-1';
            });
        }
    </script>

